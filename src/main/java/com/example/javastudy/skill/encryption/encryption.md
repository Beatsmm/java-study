# 加密后的敏感字段还能进行模糊查询吗？该如何实现？
假如现在有一个类似的场景：有一个人员管理的功能，人员信息列表的主要字段有姓名、性别、用户账号、手机号码、身份证号码、家庭住址、注册日期等，  
可以对任意一条数据进行增删改查，其中姓名，手机号，身份证号需要支持模糊查询  
简单分析一个场景，可以知道手机号、身份证号码、家庭住址等字段是敏感数据，这些字段的数据是要加密存储在数据库里，在页面上展示的时候需要进行脱敏  
如果用户想要查询真实姓名是包含有"张三"的所有人员信息，可以在页面上输入一个关键字，如张三，查询的时候这个参数会传递到后台，后台会执行sql，如  
"select * from person where name like '%张三%'",如张三，张三丰等  
如果用户想要查询手机号码为2810的用户，后台执行类似与姓名模糊查询的sql,"select * from sys_person where phone like '%2810'"，  
肯定是得不到正确的结果的，因为手机号码在数据库中的数据是加密后的数据，而2810是明文，身份证、家庭住址等其他敏感字段在模糊查询的时候也  
都有类似的问题，这就是敏感字段模糊查询的痛点，即模糊查询关键字与实际存储的数据不一致  

## 实现方案  
1、先解密在查询  
查询出目标表内所有的数据，在内存中对要模糊查询的敏感字段的加密数据进行解密，然后在遍历解密后的数据，与模糊查询关键字进行对比，筛选出包含有  
模糊查询关键字的数据行  
这种方法是最容易想到的，但有一个比较明显的问题是，模糊查询的过程是在内存中进行的，如果数据量特别大，很容易导致内存溢出，因此不推荐在生产中使用这种方法；

2、明文映射表  
新建一张映射表，存储敏感字段解密后的数据与目标表主键的映射表，需要模糊查询的时候，先对明文映射表进行模糊查询，得到符合条件的目标数据的主键，再返回来根据主键查询目标表；
这种方法，实际上是有点掩耳盗铃的感觉，敏感字段加密存储的字段主要是考虑到安全性，使用明文映射表来存储解密后的敏感字段，实际上相当于敏感字段没有加密存储，  
与最被要对敏感字段加密的初衷相违背，因此不推荐在生产中使用这种方法；

3、数据库层面进行解密查询
后台在执行查询sql时对敏感字段先解密，然后再执行like，以上面的人员管理列表模糊查询为例，即对sql的改造为：“select * from sys_person where AES_DECRYPT(phone,'key') like '%2810'”;  
这种方法的优点是，成本比较小，容易实现，但是缺点很明显，该字段无法通过数据库索引来优化查询，另外有一些数据库无法保证数据库的加解密算法与程序的加解密算法一致，  
可能会导致可以程序中加密，但是无法在数据库中解密的或者可以在数据库加密无法在程序中解密的问题，因此不推荐在生产中使用这种方法；

4、分词密文映射表  
这种方法是对第二种思路的基础上进行延伸优化，也是主流的方法，新建一张分词密文映射表，在敏感字段数据新增、修改后、对敏感字段进行分词组合，如"12345678910"  
的分词"123""4567""8910"等，在对每个分词进行加密，建立起敏感字段的分词与目标数据行主键的关联关系，在处理模糊查询的时候对模糊查询关键字进行加密，用加密后的  
模糊查询关键字，对分词密文映射表进行like查询，得到目标数据行的主键，再以目标数据行的主键为条件返回目标表进行精确查询  

淘宝密文字段检索方案

https://open.taobao.com/docV3.htm?docId=106213&docType=1


阿里巴巴文字段检索方案

https://jaq-doc.alibaba.com/docs/doc.htm?treeId=1&articleId=106213&docType=1

拼多多密文字段检索方案

https://open.pinduoduo.com/application/document/browse?idStr=3407B605226E77F2

京东密文字段检索方案

https://jos.jd.com/commondoc?listId=345

这种方法的优点就是原理简单，实现起来也不复杂，但是有一定的局限性，算是一个对性能、业务相折中的一个方案，相比较之下，在能想的方法中，比较推荐这种方法，  
但是要特别注意的是，对模糊查询的关键字的长度，要在业务层面进行限制；以手机号为例，可以要求对模糊查询的关键字是四位或者是五位，具体可以再根据具体的场景进行详细划分。  

为什么要增加这样的限制呢？因为明文加密后长度为变长，有额外的存储成本和查询性能成本，分词组合越多，需要的存储空间以及所消耗的查询性能成本也就更大，  
并且分词越短，被硬破解的可能性也就越大，也会在一定程度上导致安全性降低；